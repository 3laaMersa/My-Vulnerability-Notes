# API pentesting

- **WHAT IS API**
    - API [ Application Programming Interface ] : are mechanisms that enable two software components to communicate with each other using a set of definitions and protocols.
    
    > **Database** It is a system designed to accommodate, manage and retrieve data. It uses the new database to change big data in powerful ways , It is used in data storage for web applications, desktop, financial electronics, human resource management system, and many more
    > 
    
    > **API** is a set of rules and protocols that allow different applications to talk to each other. It is an interface that allows applications to interact with each other or with system components.
    > 
    
    ### **The basic difference between them:**
    
    Purpose: A database is for storing and managing data, while an API is for facilitating communication between different applications.
    
    Usage: Database is used to store data that can be accessed by different applications, while API is used to allow these applications to access other data or services
    
     Interaction: Interaction with the database is via direct queries to the system, while interaction with the API is via HTTP/HTTPS requests.
    
    ---
    
    ### **How do APIs work?**
    
    - When any software communicates to transfer data, the server that requests the information is called the client, and the server that provides the information is called the server.
    - The client uses API mechanisms to request specific data from the server. For example, server A wants to know what time it is, so it goes to server B, which has this information, to ask it, which in turn will respond and provide the requested data
    
    ---
    
    **There are four different ways that APIs can work depending on**
    
    - **SOAP ⇒ using XML**
    - **REST APIs ⇒  using  JSON or XML**
    - **GraphQL API**
    - **RPC API**
    
    ---
    
    ## What are the different types of APIs?
    
    APIs are classified both according to their architecture 
    and scope of use. We have already explored the main types of API 
    architectures so let’s take a look at the scope of use.
    
    ### Private APIs
    
    These are internal to an enterprise and only used for connecting systems and data within the business.
    
    ### Public APIs
    
    These are open to the public and may be used by anyone. 
    There may or not be some authorization and cost associated with these 
    types of APIs.
    
    ### Partner APIs
    
    These are only accessible by authorized external developers to aid business-to-business partnerships.
    
    ### Composite APIs
    
    These combine two or more different APIs to address complex system requirements or behaviors.
    
    ---
    
    ## What is an API endpoint and why is it important?
    
    API endpoints are the final touchpoints in the API 
    communication system. These include server URLs, services, and other 
    specific digital locations from where information is sent and received 
    between systems. API endpoints are critical to enterprises for two main 
    reasons:
    
    ### 1. Security
    
    API endpoints make the system vulnerable to attack. API monitoring is crucial for preventing misuse.
    
    ### 2. Performance
    
    API endpoints, especially high traffic ones, can cause bottlenecks and affect system performance
    
    ![Untitled](API%20pentesting%20d6bb854932e44e8fa3a1dd979f6d0014/Untitled.png)
    
    ![Untitled](API%20pentesting%20d6bb854932e44e8fa3a1dd979f6d0014/Untitled%201.png)
    
    ---
    
    > **tokens and keys are mechanisms used to authenticate and authorize access to resources.**
    > 
    
    ### **1. Authentication tokens**
    
    > A token is a piece of data that represents the authorization granted to a client to access specific resources. Tokens are often used in API authentication to ensure secure access.
    > 
    
    ```json
    {
      "access_token": "ya29.A0ARrdaM9WlImz2K7hHgH2BzR1VbsbTfXlGZi23Jv-r1D1R6zXw2zxVgF9k2wxB1gCoKf27oL-XkMP2hOhBJuRm1vIzVQ5yQ",
      "token_type": "Bearer",
      "expires_in": 3600,
      "refresh_token": "1//09vJc49D4S2yKMCgYIARAAGAkSNwF-L9Ir1r2Oyx5AqlxHjLyz3htTxhrjhjr8ffJ4",
      "scope": "https://www.googleapis.com/auth/userinfo.profile"
    }
    ```
    
    ```php
    GET /userinfo HTTP/1.1
    Host: www.googleapis.com
    Authorization: Bearer ya29.A0ARrdaM9WlImz2K7hHgH2BzR1VbsbTfXlGZi23Jv-r1D1R6zXw2zxVgF9k2wxB1gCoKf27oL-XkMP2hOhBJuRm1vIzVQ5yQ
    ```
    
    ### **2. API keys**
    
    > A key is a secret value used for authenticating and authorizing access to an API. Unlike tokens, keys are usually long-lived and are used by developers to authenticate applications rather than individual users.
    > 
    
    ```php
    X-API-KEY: 1234567890abcdef1234567890abcdef
    ```
    
    ```php
    GET /weather?location=London HTTP/1.1
    Host: api.weatherprovider.com
    X-API-KEY: 1234567890abcdef1234567890abcdef
    
    ```
    
    > **Let see the 4 method For Api contact**
    > 
    
    ![Untitled](API%20pentesting%20d6bb854932e44e8fa3a1dd979f6d0014/Untitled%202.png)
    
    ![Untitled](API%20pentesting%20d6bb854932e44e8fa3a1dd979f6d0014/Untitled%203.png)
    
- API Pentesting
    - JSON Web Token (JWT)
        - JWT consists of three parts:
            - Header Contains the token type and signature method.
            - Data (Payload) Contains the actual data.
            - Signature It is used to verify the validity of the message and not modify it.
        
        > JWT example
        > 
        
        ```php
        eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwiUGVybWlzc2lvbiAiOiJ1c2VyIiwiaWF0IjoxNTE2MjM5MDIyfQ.ytn7YuzoUZ6lJe684c_4KTacDpNMtVXDPVyn0lEBy9g
        ```
        
        Header  :
        
        > eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9
        > 
        
        Payload  :
        
        > eyJzdWIiOiIxMjM0NTY3ODkwIiwiUGVybWlzc2lvbiAiOiJ1c2VyIiwiaWF0IjoxNTE2MjM5MDIyfQ
        > 
        
        Signature :
        
        > ytn7YuzoUZ6lJe684c_4KTacDpNMtVXDPVyn0lEBy9g
        > 
        
        ---
        
        **So we can use [jwt.io](https://jwt.io/) for dacode any JWT Token :**
        
        ![Untitled](API%20pentesting%20d6bb854932e44e8fa3a1dd979f6d0014/Untitled%204.png)
        
    - **First methodology for Weakness  [ information disclosed via API ]**
        
        ---
        
        ### So Now we need to fuzz for get all endpoints and parameters
        
        ### **we can use ffuf**
        
        ---
        
        **Search for parameters in the URL:**
        
        ```php
         ffuf -u [https://web-assets.tide.co/](https://example.com/path) -w wordlist/api.txt -mc al
        ```
        
        `-mc all` = Displays all code received for the HTTP response.
        
        **Search for parameters in the request body :**
        
        ```php
        ffuf -u [https://web-assets.tide.co/](https://example.com/path) -w wordlist/api.txt -X POST -d 'FUZZ=value' -mc all
        ```
        
        `-d 'FUZZ=value'`: "FUZZ" is used as part of the body data to be sent.
        `-X POST` Specifies the use of the POST method. 
        
        **Searching for parameters in headers:**
        
        ```php
        ffuf -u [https://web-assets.tide.co/](https://example.com/path) -w wordlist/api.txt  -H "FUZZ: value" -mc all
        ```
        
        `-H "FUZZ: value"` "FUZZ" is used as part of the header.
        
        ---
        
        ***for example***
        
        1. [http://example.com/customers/103](http://example.com/customers/103)   ⇒  401
        2. [http://example.com/customers/103/orders](http://example.com/customers/103/orders) ⇒  200
        3. [http://example.com/customers/103/orders/21](http://example.com/customers/103/orders/21) ⇒  200
        
        > Sometime the original endpoint is protected , but whatever is built upon it will be completely ignored
        > 
    - **Second methodology for Weakness  [ I**nsecure direct object reference (IDOR)]
        
        > In first case we can not access the users profile but we can access some important information related to them
        > 
        
        **now in thes cas we can access the user account [ account tackover ] =Broken object level authorization (BOLA)**
        
        ---
        
        we have an API request that allows users to view their account information. The URL would look like this: 
        `https://example.com/api/v2/user/user_id`
        
        ---
        
        Suppose we have a user named aaa and id = 123
        `https://example.com/api/v2/user/123`
        
        Sending a GET HTTP request to the above endpoint will return the account information of user “test”.
        
        ```
        {
        	"Email": "aaa@gmail.com",
        	"Address":"example address for aaa"
        }
        ```
        
        If attacker replaces the user_id with a different user_id that belongs to another user,ex 456 ,this can have unexpected effects.
        `https://example.com/api/v2/user/456`
        The API would now return the account information of some other user, even though the user “test” should not be able to view this information.
        
        ```
        {
        	"Email": "bbb@gmail.com",
        	"Address":"example address for bbb"
        }
        ```
        
    - **Therd methodology for Weakness  [ Broken validation of JWT Token ]**
        
        > As we can see in the JSON Web Token tutorial after decryption, we can manipulate the data (payload) of the jwt token and encrypt it again
        > 
        
        For Exampel :
        
        This is the original token
        
        ```json
        {
          "sub": "1234567890",
          "Permission ": "user",
          "iat": 1516239022
        }
        ```
        
        **we can manipulate the Permission for example be change it like that :**
        
        ```json
        {
          "sub": "1234567890",
          "Permission ": "admin",
          "iat": 1516239022
        }
        ```
        
        **jwt will be**
        
        > eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwiUGVybWlzc2lvbiAiOiJhZG1pbiIsImlhdCI6MTUxNjIzOTAyMn0.RwhNeQml4YEd1SpZKLd1HZKL071YojnJ5jp1r6NNBfU
        > 
        
        ![Untitled](API%20pentesting%20d6bb854932e44e8fa3a1dd979f6d0014/Untitled%205.png)
        
        ### Now if we use this token in header request we can able to access the admin panel
        

###